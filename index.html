<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Link Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px 40px;
            margin-bottom: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 28px;
            color: #333;
            margin-bottom: 5px;
        }

        .header-left p {
            color: #666;
            font-size: 14px;
        }

        .header-right {
            text-align: right;
        }

        .stats-mini {
            display: flex;
            gap: 20px;
        }

        .stat-mini {
            text-align: center;
        }

        .stat-mini-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-mini-label {
            font-size: 12px;
            color: #999;
        }

        .main-content {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        .generator-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .table-panel {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: 400px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }

        .section-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .example-box {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 15px 20px;
            margin: 15px 0 25px 0;
            border-radius: 6px;
        }

        .example-box strong {
            color: #667eea;
            display: block;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .example-item {
            margin: 8px 0;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }

        .example-item code {
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 18px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .required::after {
            content: " *";
            color: #dc3545;
            font-weight: bold;
        }

        input[type="text"],
        textarea,
        select {
            padding: 11px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 90px;
            line-height: 1.5;
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .help-text {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
            line-height: 1.4;
        }

        .btn {
            padding: 13px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary { background: #6c757d; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-small { padding: 7px 16px; font-size: 13px; }

        .table-container {
            overflow-x: auto;
            max-height: 550px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        th input[type="checkbox"] {
            cursor: pointer;
        }

        tr:hover {
            background: #f8f9fa;
        }

        tr.selected {
            background: #e7f3ff;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-badge.created { background: #d4edda; color: #155724; }
        .status-badge.pending { background: #fff3cd; color: #856404; }

        .link-cell {
            font-family: monospace;
            font-size: 12px;
            color: #333;
            word-break: break-all;
            line-height: 1.5;
            max-width: 400px;
        }

        .short-link {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-family: monospace;
            font-size: 12px;
        }

        .short-link:hover {
            text-decoration: underline;
        }

        .action-btn {
            padding: 5px 12px;
            font-size: 12px;
            margin-right: 4px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .selection-info {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .alert {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .bitly-panel {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ffc107;
        }

        .bitly-panel h4 {
            margin-bottom: 12px;
            color: #333;
            font-size: 16px;
        }

        .note-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .note-input:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="file"] {
            display: none;
        }

        .batch-indicator {
            background: #f0f7ff;
            border: 2px dashed #667eea;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            color: #667eea;
            text-align: center;
            font-weight: 600;
        }

        .duplicate-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 13px;
            color: #856404;
        }

        .token-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .token-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .token-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .link-mode-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .link-mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .link-mode-toggle input:checked + .toggle-slider {
            background-color: #667eea;
        }

        .link-mode-toggle input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .mode-label {
            font-size: 11px;
            color: #999;
            margin-left: 8px;
            font-weight: 600;
        }

        .mode-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üîó UTM Link Manager</h1>
                <p>Create tracking links for all your marketing channels</p>
            </div>
            <div class="header-right">
                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-number" id="headerTotal">0</div>
                        <div class="stat-mini-label">Total Links</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number" id="headerShort">0</div>
                        <div class="stat-mini-label">Short Links</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Generator Panel -->
            <div class="generator-panel">
                <div class="section-title">Link Generator</div>
                <div class="section-subtitle">
                    Create single or batch links. Source, Medium, and Names all support batch input (one per line).
                </div>

                <div class="example-box">
                    <strong>üí° Examples:</strong>
                    <div class="example-item">Single: <code>twitter</code> + empty Names ‚Üí <code>links.comfy.org/twitter</code></div>
                    <div class="example-item">Batch Names: <code>bilibili</code> + 10 names ‚Üí 10 links like <code>bili-creator1</code></div>
                    <div class="example-item">Batch Sources: <code>Other ‚Üí tiktok, telegram</code> ‚Üí 2 links for each platform</div>
                    <div class="example-item">Combined: 3 sources √ó 5 names = 15 links!</div>
                </div>

                <div class="form-grid">
                    <div class="form-group form-group-full">
                        <label for="baseUrl" class="required">Destination URL</label>
                        <input type="text" id="baseUrl" placeholder="https://www.comfy.org/" value="https://www.comfy.org/">
                        <div class="help-text">Where users land</div>
                    </div>

                    <div class="form-group">
                        <label for="utmSource" class="required">Source</label>
                        <select id="utmSource" onchange="handleSourceChange()">
                            <option value="">-- Select --</option>
                            <optgroup label="Global Platforms">
                                <option value="twitter">twitter</option>
                                <option value="discord">discord</option>
                                <option value="github">github</option>
                                <option value="youtube">youtube</option>
                                <option value="linkedin">linkedin</option>
                                <option value="reddit">reddit</option>
                                <option value="instagram">instagram</option>
                                <option value="facebook">facebook</option>
                            </optgroup>
                            <optgroup label="Chinese Platforms">
                                <option value="bilibili">bilibili</option>
                                <option value="wechat">wechat</option>
                                <option value="wechat_group">wechat_group</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="email">email</option>
                                <option value="partner">partner</option>
                                <option value="influencer">influencer</option>
                                <option value="other">‚úèÔ∏è Other (custom)</option>
                            </optgroup>
                        </select>
                        <textarea id="utmSourceCustom" placeholder="One per line for batch:&#10;tiktok&#10;telegram&#10;newsletter" style="display: none; margin-top: 8px; min-height: 80px; resize: vertical;" oninput="updateSourceBatchIndicator()"></textarea>
                        <div id="sourceBatchIndicator" style="display: none; font-size: 11px; color: #667eea; margin-top: 5px; font-weight: 600;"></div>
                        <div class="help-text">Traffic platform (supports batch: one per line)</div>
                    </div>

                    <div class="form-group">
                        <label for="utmMedium">Medium</label>
                        <select id="utmMedium" onchange="handleMediumChange()">
                            <option value="">-- Auto --</option>
                            <option value="social">social</option>
                            <option value="video">video</option>
                            <option value="community">community</option>
                            <option value="influencer">influencer</option>
                            <option value="referral">referral</option>
                            <option value="email">email</option>
                            <option value="partner">partner</option>
                            <option value="paid_social">paid_social</option>
                            <option value="other">‚úèÔ∏è Other (custom)</option>
                        </select>
                        <textarea id="utmMediumCustom" placeholder="One per line for batch:&#10;podcast&#10;webinar" style="display: none; margin-top: 8px; min-height: 80px; resize: vertical;" oninput="updateMediumBatchIndicator()"></textarea>
                        <div id="mediumBatchIndicator" style="display: none; font-size: 11px; color: #667eea; margin-top: 5px; font-weight: 600;"></div>
                        <div class="help-text">Channel type (supports batch: one per line)</div>
                    </div>

                    <div class="form-group">
                        <label for="utmCampaign">Campaign</label>
                        <input type="text" id="utmCampaign" list="campaignSuggestions" placeholder="e.g., cloud_beta_launch_2024" onchange="updateShortAlias()">
                        <datalist id="campaignSuggestions">
                            <option value="cloud_beta_launch">
                            <option value="influencer_collab">
                            <option value="product_launch">
                            <option value="partnership">
                            <option value="webinar_series">
                            <option value="holiday_sale">
                            <option value="community_event">
                            <option value="tutorial_series">
                            <option value="showcase">
                            <option value="giveaway">
                        </datalist>
                        <div class="help-text">Marketing activity name (custom or select suggestion)</div>
                    </div>

                    <div class="form-group">
                        <label for="shortPrefix">Short Prefix</label>
                        <input type="text" id="shortPrefix" placeholder="Auto-suggested">
                        <div class="help-text">For short URLs</div>
                    </div>

                    <div class="form-group">
                        <label for="linkNote">Note</label>
                        <input type="text" id="linkNote" placeholder="Your memo">
                        <div class="help-text">Internal only</div>
                    </div>

                    <div class="form-group">
                        <label>Mode</label>
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="radio" name="defaultLinkMode" value="custom" checked style="margin-right: 8px;">
                                <span style="font-weight: normal; color: #666;">Custom</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="radio" name="defaultLinkMode" value="random" style="margin-right: 8px;">
                                <span style="font-weight: normal; color: #666;">Random</span>
                            </label>
                        </div>
                        <div class="help-text">Default for new links</div>
                    </div>

                    <div class="form-group form-group-full">
                        <label for="batchNames">
                            Names / Variants (utm_content)
                            <button class="btn btn-small btn-secondary" onclick="clearNamesField()" style="float: right; padding: 4px 12px;">üóëÔ∏è Clear</button>
                        </label>
                        <textarea id="batchNames" placeholder="Empty = no utm_content&#10;1 line = 1 link with utm_content&#10;&#10;creator_john&#10;creator_jane"></textarea>
                        <div class="help-text">Empty: single link without content | With names: each name becomes utm_content</div>
                    </div>
                </div>

                <div id="batchIndicator" class="batch-indicator" style="display: none;">
                    Will create <strong><span id="batchCount">0</span> links</strong>
                </div>

                <button class="btn" onclick="generateLinks()" style="margin-top: 15px;">
                    ‚ö° Generate Links
                </button>
            </div>

            <!-- Table Panel -->
            <div class="table-panel">
                <div class="section-title">Generated Links</div>
                <div class="section-subtitle">
                    Edit Short Alias and Note in table. Toggle Mode switch for each link. Select rows to push to Bitly.
                </div>

                <div class="toolbar">
                    <div class="toolbar-left">
                        <span class="token-status" id="tokenStatus">
                            <span id="tokenStatusIcon">‚ö†Ô∏è</span>
                            <span id="tokenStatusText">No Bitly Token</span>
                        </span>
                        <span class="selection-info" id="selectionInfo">0 selected</span>
                        <button class="btn btn-small btn-success" id="bulkBitlyBtn" onclick="createBitlyForSelected()" disabled style="display: none;">
                            üîó Push to Bitly
                        </button>
                        <button class="btn btn-small btn-danger" id="bulkDeleteBtn" onclick="deleteSelected()" disabled>
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-small" onclick="exportToCSV()">üíæ Export</button>
                        <button class="btn btn-small btn-secondary" onclick="importFromCSV()">üìÅ Import</button>
                        <button class="btn btn-small btn-warning" onclick="showBitlyPanel()">‚öôÔ∏è Setup Token</button>
                    </div>
                </div>

                <input type="file" id="importFileInput" accept=".csv" onchange="handleImportFile(event)">

                <!-- Bitly Settings Panel -->
                <div class="bitly-panel" id="bitlyPanel" style="display: none;">
                    <h4>‚öôÔ∏è Bitly API Token</h4>
                    <div class="help-text" style="margin-bottom: 15px; color: #856404;">
                        Get token: <a href="https://bitly.com" target="_blank" style="color: #667eea;">bitly.com</a> ‚Üí Settings ‚Üí Developer Settings ‚Üí API
                    </div>
                    <div class="form-group">
                        <label for="bitlyApiToken">Token</label>
                        <input type="text" id="bitlyApiToken" placeholder="Paste token here" style="margin-bottom: 10px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small" onclick="verifyAndSaveBitlyToken()">‚úÖ Verify</button>
                        <button class="btn btn-small btn-danger" onclick="clearBitlyToken()">üóëÔ∏è Clear</button>
                        <button class="btn btn-small btn-secondary" onclick="hideBitlyPanel()">Close</button>
                    </div>
                </div>

                <div class="table-container" id="tableContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No links yet. Generate your first link above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let links = JSON.parse(localStorage.getItem('comfyui_utm_links') || '[]');
        let selectedIndices = new Set();
        let bitlyTokenValid = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTable();
            updateStats();
            loadBitlyToken();
            checkBitlyToken();
            loadFormState();
            
            // Update batch indicator on input
            document.getElementById('batchNames').addEventListener('input', updateBatchIndicator);
            
            // Auto-save form state on change
            document.getElementById('baseUrl').addEventListener('change', saveFormState);
            document.getElementById('utmSource').addEventListener('change', saveFormState);
            document.getElementById('utmSourceCustom').addEventListener('input', saveFormState);
            document.getElementById('utmMedium').addEventListener('change', saveFormState);
            document.getElementById('utmMediumCustom').addEventListener('input', saveFormState);
            document.getElementById('utmCampaign').addEventListener('input', saveFormState);
            document.getElementById('shortPrefix').addEventListener('change', saveFormState);
            document.getElementById('linkNote').addEventListener('change', saveFormState);
            
            // Save names field on input (debounced)
            let namesSaveTimeout;
            document.getElementById('batchNames').addEventListener('input', function() {
                clearTimeout(namesSaveTimeout);
                namesSaveTimeout = setTimeout(saveFormState, 500);
            });
        });

        function saveFormState() {
            const formState = {
                baseUrl: document.getElementById('baseUrl').value,
                utmSource: document.getElementById('utmSource').value,
                utmSourceCustom: document.getElementById('utmSourceCustom').value,
                utmMedium: document.getElementById('utmMedium').value,
                utmMediumCustom: document.getElementById('utmMediumCustom').value,
                utmCampaign: document.getElementById('utmCampaign').value,
                shortPrefix: document.getElementById('shortPrefix').value,
                linkNote: document.getElementById('linkNote').value,
                batchNames: document.getElementById('batchNames').value,
                defaultLinkMode: document.querySelector('input[name="defaultLinkMode"]:checked').value
            };
            localStorage.setItem('form_state', JSON.stringify(formState));
        }

        function loadFormState() {
            const saved = localStorage.getItem('form_state');
            if (!saved) return;
            
            try {
                const formState = JSON.parse(saved);
                
                if (formState.baseUrl) document.getElementById('baseUrl').value = formState.baseUrl;
                if (formState.utmSource) document.getElementById('utmSource').value = formState.utmSource;
                if (formState.utmSourceCustom) document.getElementById('utmSourceCustom').value = formState.utmSourceCustom;
                if (formState.utmMedium) document.getElementById('utmMedium').value = formState.utmMedium;
                if (formState.utmMediumCustom) document.getElementById('utmMediumCustom').value = formState.utmMediumCustom;
                if (formState.utmCampaign) document.getElementById('utmCampaign').value = formState.utmCampaign;
                if (formState.shortPrefix) document.getElementById('shortPrefix').value = formState.shortPrefix;
                if (formState.linkNote) document.getElementById('linkNote').value = formState.linkNote;
                if (formState.batchNames) document.getElementById('batchNames').value = formState.batchNames;
                
                if (formState.defaultLinkMode) {
                    document.querySelectorAll('input[name="defaultLinkMode"]').forEach(radio => {
                        radio.checked = radio.value === formState.defaultLinkMode;
                    });
                }
                
                // Restore custom input visibility and batch indicators
                if (formState.utmSource === 'other' && formState.utmSourceCustom) {
                    document.getElementById('utmSourceCustom').style.display = 'block';
                    updateSourceBatchIndicator();
                }
                if (formState.utmMedium === 'other' && formState.utmMediumCustom) {
                    document.getElementById('utmMediumCustom').style.display = 'block';
                    updateMediumBatchIndicator();
                }
                
                // Update short alias if source is loaded
                if (formState.utmSource) {
                    updateShortAlias();
                }
                
                // Update batch indicator if names are loaded
                if (formState.batchNames) {
                    updateBatchIndicator();
                }
            } catch (error) {
                console.error('Error loading form state:', error);
            }
        }

        function clearNamesField() {
            document.getElementById('batchNames').value = '';
            updateBatchIndicator();
            saveFormState();
        }

        async function checkBitlyToken() {
            const token = localStorage.getItem('bitly_api_token');
            
            if (!token) {
                updateTokenStatus(false, 'No Token');
                return;
            }

            try {
                const response = await fetch('https://api-ssl.bitly.com/v4/user', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    bitlyTokenValid = true;
                    const data = await response.json();
                    updateTokenStatus(true, data.login || 'Connected');
                } else {
                    bitlyTokenValid = false;
                    updateTokenStatus(false, 'Invalid Token');
                }
            } catch (error) {
                bitlyTokenValid = false;
                updateTokenStatus(false, 'Connection Error');
            }
        }

        function updateTokenStatus(valid, text) {
            const statusEl = document.getElementById('tokenStatus');
            const iconEl = document.getElementById('tokenStatusIcon');
            const textEl = document.getElementById('tokenStatusText');
            const pushBtn = document.getElementById('bulkBitlyBtn');
            
            if (valid) {
                statusEl.className = 'token-status connected';
                iconEl.textContent = '‚úÖ';
                textEl.textContent = text;
                pushBtn.style.display = 'inline-block';
            } else {
                statusEl.className = 'token-status disconnected';
                iconEl.textContent = '‚ö†Ô∏è';
                textEl.textContent = text;
                pushBtn.style.display = 'none';
            }
            
            updateSelectionInfo();
        }

        function updateBatchIndicator() {
            const names = document.getElementById('batchNames').value.trim();
            const indicator = document.getElementById('batchIndicator');
            const countSpan = document.getElementById('batchCount');
            
            if (!names) {
                indicator.style.display = 'none';
                return;
            }
            
            const count = names.split('\n').filter(n => n.trim()).length;
            countSpan.textContent = count;
            indicator.style.display = 'block';
        }

        function handleSourceChange() {
            const sourceSelect = document.getElementById('utmSource');
            const sourceCustom = document.getElementById('utmSourceCustom');
            const indicator = document.getElementById('sourceBatchIndicator');
            
            if (sourceSelect.value === 'other') {
                sourceCustom.style.display = 'block';
                sourceCustom.focus();
            } else {
                sourceCustom.style.display = 'none';
                sourceCustom.value = '';
                indicator.style.display = 'none';
            }
            
            updateShortAlias();
        }

        function handleMediumChange() {
            const mediumSelect = document.getElementById('utmMedium');
            const mediumCustom = document.getElementById('utmMediumCustom');
            const indicator = document.getElementById('mediumBatchIndicator');
            
            if (mediumSelect.value === 'other') {
                mediumCustom.style.display = 'block';
                mediumCustom.focus();
            } else {
                mediumCustom.style.display = 'none';
                mediumCustom.value = '';
                indicator.style.display = 'none';
            }
        }

        function updateSourceBatchIndicator() {
            const sourceCustom = document.getElementById('utmSourceCustom').value.trim();
            const indicator = document.getElementById('sourceBatchIndicator');
            
            if (!sourceCustom) {
                indicator.style.display = 'none';
                return;
            }
            
            const sources = sourceCustom.split('\n').filter(s => s.trim());
            if (sources.length > 1) {
                indicator.textContent = `üì¶ Batch: ${sources.length} sources`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
            
            updateShortAlias();
        }

        function updateMediumBatchIndicator() {
            const mediumCustom = document.getElementById('utmMediumCustom').value.trim();
            const indicator = document.getElementById('mediumBatchIndicator');
            
            if (!mediumCustom) {
                indicator.style.display = 'none';
                return;
            }
            
            const mediums = mediumCustom.split('\n').filter(m => m.trim());
            if (mediums.length > 1) {
                indicator.textContent = `üì¶ Batch: ${mediums.length} mediums`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        function getSourceValues() {
            const sourceSelect = document.getElementById('utmSource').value;
            const sourceCustom = document.getElementById('utmSourceCustom').value.trim();
            
            if (sourceSelect === 'other' && sourceCustom) {
                return sourceCustom.split('\n').map(s => s.trim()).filter(s => s);
            }
            return sourceSelect ? [sourceSelect] : [];
        }

        function getMediumValues() {
            const mediumSelect = document.getElementById('utmMedium').value;
            const mediumCustom = document.getElementById('utmMediumCustom').value.trim();
            
            if (mediumSelect === 'other' && mediumCustom) {
                return mediumCustom.split('\n').map(m => m.trim()).filter(m => m);
            }
            return mediumSelect ? [mediumSelect] : [''];
        }

        function getSourceValue() {
            const values = getSourceValues();
            return values.length > 0 ? values[0] : '';
        }

        function getMediumValue() {
            const values = getMediumValues();
            return values.length > 0 ? values[0] : '';
        }

        function updateShortAlias() {
            const source = getSourceValue();
            const baseUrl = document.getElementById('baseUrl').value;
            
            if (!source) return;
            
            const shortMap = {
                'twitter': 'tw', 'discord': 'dc', 'youtube': 'yt', 'linkedin': 'li',
                'reddit': 'rd', 'instagram': 'ig', 'facebook': 'fb', 'bilibili': 'bili',
                'wechat': 'wx', 'wechat_group': 'wxg', 'weibo': 'wb', 
                'xiaohongshu': 'xhs', 'zhihu': 'zh', 'douyin': 'dy', 'github': 'gh'
            };
            
            let suffix = '';
            if (baseUrl.includes('download')) suffix = '-dl';
            else if (baseUrl.includes('cloud')) suffix = '-cloud';
            else if (baseUrl.includes('docs')) suffix = '-docs';
            else if (baseUrl.includes('blog')) suffix = '-blog';
            else if (baseUrl.includes('tutorials')) suffix = '-tut';
            
            const prefix = (shortMap[source] || source.substring(0, 4)) + suffix;
            document.getElementById('shortPrefix').value = prefix;
        }

        function generateLinks() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const sources = getSourceValues();
            const mediums = getMediumValues();
            const campaign = document.getElementById('utmCampaign').value;
            const namesInput = document.getElementById('batchNames').value.trim();
            const shortPrefix = document.getElementById('shortPrefix').value.trim();

            if (!baseUrl || sources.length === 0) {
                alert('Please fill in: Destination URL and Platform');
                return;
            }

            const names = namesInput ? namesInput.split('\n').map(n => n.trim()).filter(n => n) : [''];
            
            const newLinks = [];
            const duplicates = [];
            
            let linkIndex = 0;
            
            // Create cartesian product: sources √ó mediums √ó names
            sources.forEach(source => {
                mediums.forEach(medium => {
                    names.forEach(name => {
                        const params = new URLSearchParams();
                        params.append('utm_source', source);
                        
                        // Only add medium if it has a value
                        if (medium) {
                            params.append('utm_medium', medium);
                        }
                        
                        // Only add campaign if user selected one
                        if (campaign) {
                            params.append('utm_campaign', campaign);
                        }
                        
                        // Only add content if there is a name
                        if (name) {
                            params.append('utm_content', name);
                        }

                        const separator = baseUrl.includes('?') ? '&' : '?';
                        const fullUrl = baseUrl + separator + params.toString();

                        // Check for duplicate URL
                        const existingLink = links.find(l => l.fullUrl === fullUrl);
                        if (existingLink) {
                            duplicates.push({ name: name || source, url: fullUrl });
                            return; // Skip this link
                        }

                        let shortAlias = '';
                        const shortMap = {
                            'twitter': 'tw', 'discord': 'dc', 'youtube': 'yt', 'linkedin': 'li',
                            'reddit': 'rd', 'instagram': 'ig', 'facebook': 'fb', 'bilibili': 'bili',
                            'wechat': 'wx', 'wechat_group': 'wxg', 'weibo': 'wb', 
                            'xiaohongshu': 'xhs', 'zhihu': 'zh', 'douyin': 'dy', 'github': 'gh'
                        };
                        
                        const sourcePrefix = shortMap[source] || source.substring(0, 4).toLowerCase();
                        
                        if (name && shortPrefix) {
                            const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').substring(0, 30);
                            shortAlias = `${shortPrefix}-${cleanName}`;
                        } else if (name) {
                            const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').substring(0, 30);
                            shortAlias = `${sourcePrefix}-${cleanName}`;
                        } else if (shortPrefix) {
                            shortAlias = shortPrefix;
                        } else {
                            shortAlias = sourcePrefix + (baseUrl.includes('download') ? '-dl' : baseUrl.includes('cloud') ? '-cloud' : '');
                        }

                        // Check for duplicate short alias
                        if (shortAlias) {
                            const existingAlias = links.find(l => l.shortAlias === shortAlias);
                            if (existingAlias) {
                                shortAlias = shortAlias + '-' + Date.now().toString().slice(-4);
                            }
                        }

                        // Get default link mode from radio buttons
                        const defaultMode = document.querySelector('input[name="defaultLinkMode"]:checked').value;
                        
                        newLinks.push({
                            id: Date.now() + linkIndex++,
                            baseUrl: baseUrl,
                            fullUrl: fullUrl,
                            source: source,
                            medium: medium,
                            campaign: campaign,
                            content: name,
                            shortAlias: shortAlias,
                            note: name ? `${source} - ${name}` : `${source} - ${campaign || 'link'}`,
                            shortLink: '',
                            useCustomAlias: defaultMode === 'custom',
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        });
                    });
                });
            });

            if (duplicates.length > 0) {
                const dupList = duplicates.slice(0, 5).map(d => `‚Ä¢ ${d.name}`).join('\n');
                const more = duplicates.length > 5 ? `\n... and ${duplicates.length - 5} more` : '';
                alert(`‚ö†Ô∏è Found ${duplicates.length} duplicate link(s):\n\n${dupList}${more}\n\nDuplicates were skipped.`);
            }

            if (newLinks.length === 0) {
                alert('No new links to add. All links already exist.');
                return;
            }

            links.unshift(...newLinks);
            saveLinks();
            updateTable();
            updateStats();

            // Only clear Names field if it was a batch (keep everything else for next use)
            if (namesInput) {
                // Don't auto-clear - let user decide when to clear
                // User can click the "Clear" button if needed
            }
            
            const skipped = duplicates.length > 0 ? ` (${duplicates.length} skipped)` : '';
            showToast(`‚úÖ ${newLinks.length} link${newLinks.length > 1 ? 's' : ''} added!${skipped}`);
        }

        function updateTable() {
            const container = document.getElementById('tableContainer');
            
            if (links.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No links yet. Generate your first link above!</p>
                    </div>
                `;
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th style="width: 40px;"><input type="checkbox" onchange="toggleSelectAll(this)"></th>';
            html += '<th style="width: 100px;">Source</th>';
            html += '<th style="width: 140px;">Campaign</th>';
            html += '<th style="width: 120px;">Content</th>';
            html += '<th style="min-width: 350px;">Long URL</th>';
            html += '<th style="min-width: 150px;">Short Alias</th>';
            html += '<th style="width: 100px;">Mode</th>';
            html += '<th style="min-width: 120px;">Short Link</th>';
            html += '<th style="min-width: 150px;">Note</th>';
            html += '<th style="width: 80px;">Status</th>';
            html += '<th style="width: 140px;">Actions</th>';
            html += '</tr></thead><tbody>';

            links.forEach((link, index) => {
                const isSelected = selectedIndices.has(index);
                html += `<tr class="${isSelected ? 'selected' : ''}">`;
                html += `<td><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect(${index}, this.checked)"></td>`;
                html += `<td><strong>${link.source}</strong></td>`;
                html += `<td>${link.campaign}</td>`;
                html += `<td>${link.content || '-'}</td>`;
                html += `<td><div class="link-cell">${link.fullUrl}</div></td>`;
                html += `<td><input type="text" class="note-input" value="${link.shortAlias || ''}" onchange="updateShortAliasInline(${index}, this.value)" placeholder="Enter alias"></td>`;
                html += `<td>
                    <div class="mode-indicator">
                        <label class="link-mode-toggle">
                            <input type="checkbox" ${link.useCustomAlias === true ? 'checked' : ''} onchange="toggleLinkMode(${index}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="mode-label">${link.useCustomAlias === true ? 'Custom' : 'Random'}</span>
                    </div>
                </td>`;
                html += `<td>${link.shortLink ? `<a href="${link.shortLink}" target="_blank" class="short-link">${link.shortLink.replace('https://links.comfy.org/', '')}</a>` : '<span style="color: #999;">-</span>'}</td>`;
                html += `<td><input type="text" class="note-input" value="${escapeHtml(link.note || '')}" onchange="updateNote(${index}, this.value)" placeholder="Add note"></td>`;
                html += `<td><span class="status-badge ${link.shortLink ? 'created' : 'pending'}">${link.shortLink ? 'Created' : 'Pending'}</span></td>`;
                html += `<td>
                    <button class="btn btn-small action-btn" onclick="copyFromTable(${index})">Copy</button>
                    <button class="btn btn-small btn-danger action-btn" onclick="deleteLink(${index})">Del</button>
                </td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            updateSelectionInfo();
        }


        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function toggleSelect(index, checked) {
            if (checked) {
                selectedIndices.add(index);
            } else {
                selectedIndices.delete(index);
            }
            updateTable();
        }

        function toggleSelectAll(checkbox) {
            if (checkbox.checked) {
                links.forEach((_, index) => selectedIndices.add(index));
            } else {
                selectedIndices.clear();
            }
            updateTable();
        }

        function updateSelectionInfo() {
            const count = selectedIndices.size;
            document.getElementById('selectionInfo').textContent = `${count} selected`;
            
            // Only enable push button if token is valid
            const pushBtn = document.getElementById('bulkBitlyBtn');
            if (bitlyTokenValid) {
                pushBtn.disabled = count === 0;
                pushBtn.style.display = 'inline-block';
            } else {
                pushBtn.disabled = true;
                pushBtn.style.display = 'none';
            }
            
            document.getElementById('bulkDeleteBtn').disabled = count === 0;
        }

        function updateShortAliasInline(index, value) {
            links[index].shortAlias = value.trim();
            saveLinks();
        }

        function updateNote(index, value) {
            links[index].note = value.trim();
            saveLinks();
        }

        function toggleLinkMode(index, useCustom) {
            links[index].useCustomAlias = useCustom;
            saveLinks();
            updateTable();
        }

        function copyFromTable(index) {
            const link = links[index];
            const text = link.shortLink || link.fullUrl;
            navigator.clipboard.writeText(text).then(() => {
                showToast('‚úÖ Copied!');
            });
        }

        function deleteLink(index) {
            if (confirm('Delete this link?')) {
                links.splice(index, 1);
                selectedIndices.delete(index);
                saveLinks();
                updateTable();
                updateStats();
            }
        }

        function deleteSelected() {
            if (selectedIndices.size === 0) return;
            
            if (confirm(`Delete ${selectedIndices.size} selected link${selectedIndices.size > 1 ? 's' : ''}?`)) {
                const indicesToDelete = Array.from(selectedIndices).sort((a, b) => b - a);
                indicesToDelete.forEach(index => links.splice(index, 1));
                selectedIndices.clear();
                saveLinks();
                updateTable();
                updateStats();
            }
        }

        function updateStats() {
            const total = links.length;
            const withShort = links.filter(l => l.shortLink).length;
            
            document.getElementById('headerTotal').textContent = total;
            document.getElementById('headerShort').textContent = withShort;
        }

        function saveLinks() {
            localStorage.setItem('comfyui_utm_links', JSON.stringify(links));
        }

        function showBitlyPanel() {
            const panel = document.getElementById('bitlyPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function hideBitlyPanel() {
            document.getElementById('bitlyPanel').style.display = 'none';
        }

        function loadBitlyToken() {
            const saved = localStorage.getItem('bitly_api_token');
            if (saved) {
                document.getElementById('bitlyApiToken').value = saved;
            }
        }

        function saveBitlyToken() {
            const token = document.getElementById('bitlyApiToken').value.trim();
            if (token) {
                localStorage.setItem('bitly_api_token', token);
            }
        }

        function clearBitlyToken() {
            if (confirm('Remove saved Bitly token? You will need to re-enter it next time.')) {
                localStorage.removeItem('bitly_api_token');
                document.getElementById('bitlyApiToken').value = '';
                bitlyTokenValid = false;
                updateTokenStatus(false, 'No Token');
                alert('‚úÖ Token cleared successfully!');
            }
        }

        async function verifyAndSaveBitlyToken() {
            const apiToken = document.getElementById('bitlyApiToken').value.trim();
            
            if (!apiToken) {
                alert('Please enter API token');
                return;
            }

            try {
                const response = await fetch('https://api-ssl.bitly.com/v4/user', {
                    headers: { 'Authorization': `Bearer ${apiToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    saveBitlyToken();
                    bitlyTokenValid = true;
                    updateTokenStatus(true, data.login || 'Connected');
                    hideBitlyPanel();
                    alert(`‚úÖ Token verified and saved!\n\nLogged in as: ${data.login || data.name}`);
                } else {
                    bitlyTokenValid = false;
                    updateTokenStatus(false, 'Invalid Token');
                    alert('‚ùå Invalid token. Please check and try again.');
                }
            } catch (error) {
                bitlyTokenValid = false;
                updateTokenStatus(false, 'Connection Error');
                alert('‚ùå Connection error: ' + error.message);
            }
        }

        async function createBitlyForSelected() {
            const apiToken = localStorage.getItem('bitly_api_token');
            
            if (!apiToken || !bitlyTokenValid) {
                alert('Please set up and verify Bitly API token first (click "‚öôÔ∏è Setup Token" button)');
                showBitlyPanel();
                return;
            }

            const selectedLinks = Array.from(selectedIndices)
                .map(i => ({ ...links[i], originalIndex: i }))
                .filter(l => !l.shortLink);

            if (selectedLinks.length === 0) {
                alert('Selected links already have short links.');
                return;
            }

            // Check for missing aliases in custom mode links
            const customLinks = selectedLinks.filter(l => l.useCustomAlias === true);
            const missingAlias = customLinks.filter(l => !l.shortAlias);
            if (missingAlias.length > 0) {
                alert(`‚ö†Ô∏è ${missingAlias.length} link(s) using Custom mode are missing short alias.\n\nPlease:\n1. Add alias in table, OR\n2. Switch those links to Random mode (toggle switch)`);
                return;
            }

            const customCount = selectedLinks.filter(l => l.useCustomAlias === true).length;
            const randomCount = selectedLinks.length - customCount;
            let modeText = '';
            if (customCount > 0 && randomCount > 0) {
                modeText = `${customCount} custom + ${randomCount} random`;
            } else if (customCount > 0) {
                modeText = 'custom aliases';
            } else {
                modeText = 'random codes';
            }
            
            if (!confirm(`Create ${selectedLinks.length} short link${selectedLinks.length > 1 ? 's' : ''} (${modeText})?`)) {
                return;
            }

            let successCount = 0;
            let errorCount = 0;
            const errors = [];

            for (let i = 0; i < selectedLinks.length; i++) {
                const link = selectedLinks[i];
                
                showToast(`Creating ${i + 1}/${selectedLinks.length}: ${link.shortAlias}...`, false);

                const result = await createBitlyShortLink(apiToken, link);
                
                if (result.success) {
                    links[link.originalIndex].shortLink = result.shortLink;
                    links[link.originalIndex].status = 'created';
                    successCount++;
                } else {
                    errorCount++;
                    errors.push({ alias: link.shortAlias, error: result.error });
                }

                saveLinks();
                
                if (i < selectedLinks.length - 1) {
                    await sleep(600);
                }
            }

            selectedIndices.clear();
            updateTable();
            updateStats();
            
            let message = `‚úÖ Complete!\n\nSuccess: ${successCount}\nFailed: ${errorCount}`;
            if (errors.length > 0 && errors.length <= 5) {
                message += '\n\nErrors:\n' + errors.map(e => `‚Ä¢ ${e.alias}: ${e.error}`).join('\n');
            }
            alert(message);
        }

        async function createBitlyShortLink(apiToken, link) {
            const payload = {
                long_url: link.fullUrl,
                domain: 'links.comfy.org'
            };

            // Add custom keyword only if this specific link uses custom mode AND has an alias
            if (link.useCustomAlias === true && link.shortAlias) {
                payload.keyword = link.shortAlias;  // Use 'keyword' parameter for custom aliases
                console.log(`Creating CUSTOM short link with keyword: ${link.shortAlias}`);
            } else {
                console.log(`Creating RANDOM short link for: ${link.fullUrl}`);
            }

            console.log('üì§ Bitly API Request Payload:', JSON.stringify(payload, null, 2));

            try {
                // Use /v4/bitlinks endpoint instead of /v4/shorten for custom keywords
                const response = await fetch('https://api-ssl.bitly.com/v4/bitlinks', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log('üì• Bitly API Response Status:', response.status);

                const data = await response.json();
                console.log('üì• Bitly API Response Data:', JSON.stringify(data, null, 2));

                if (response.ok) {
                    return { success: true, shortLink: data.link };
                } else {
                    return { success: false, error: data.message || data.description || 'Unknown error' };
                }
            } catch (error) {
                console.error('‚ùå Bitly API Error:', error);
                return { success: false, error: error.message };
            }
        }

        function exportToCSV() {
            if (links.length === 0) {
                alert('No links to export');
                return;
            }

            let csv = 'Source,Medium,Campaign,Content,Base_URL,Full_URL,Short_Alias,Short_Link,Note,Status,Created_At\n';
            
            links.forEach(link => {
                csv += `"${link.source}",`;
                csv += `"${link.medium}",`;
                csv += `"${link.campaign}",`;
                csv += `"${link.content || ''}",`;
                csv += `"${link.baseUrl}",`;
                csv += `"${link.fullUrl}",`;
                csv += `"${link.shortAlias || ''}",`;
                csv += `"${link.shortLink || ''}",`;
                csv += `"${link.note || ''}",`;
                csv += `"${link.status}",`;
                csv += `"${link.createdAt}"\n`;
            });

            downloadCSV(csv, `comfyui_links_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function importFromCSV() {
            document.getElementById('importFileInput').click();
        }

        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const lines = e.target.result.split('\n');
                    let importedCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = parseCSVLine(lines[i]);
                        if (values.length < 6) continue;
                        
                        links.push({
                            id: Date.now() + i,
                            source: values[0] || '',
                            medium: values[1] || '',
                            campaign: values[2] || '',
                            content: values[3] || '',
                            baseUrl: values[4] || '',
                            fullUrl: values[5] || '',
                            shortAlias: values[6] || '',
                            shortLink: values[7] || '',
                            note: values[8] || '',
                            status: values[9] || 'pending',
                            createdAt: values[10] || new Date().toISOString()
                        });
                        importedCount++;
                    }
                    
                    saveLinks();
                    updateTable();
                    updateStats();
                    alert(`‚úÖ Imported ${importedCount} links!`);
                } catch (error) {
                    alert('‚ùå Import error: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(v => v.replace(/^"|"$/g, '').trim());
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showToast(message, autoHide = true) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 14px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 10000;
                box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            `;
            document.body.appendChild(toast);

            if (autoHide) {
                setTimeout(() => toast.remove(), 2500);
            } else {
                setTimeout(() => toast.remove(), 1000);
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>


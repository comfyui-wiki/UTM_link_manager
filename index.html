<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Link Manager</title>
    <!-- SweetAlert2 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üîó UTM Link Manager</h1>
                <p>Create tracking links for all your marketing channels</p>
            </div>
            <div class="header-right">
                <div class="stats-mini">
                    <div class="stat-mini">
                        <div class="stat-mini-number" id="headerTotal">0</div>
                        <div class="stat-mini-label">Total Links</div>
                    </div>
                    <div class="stat-mini">
                        <div class="stat-mini-number" id="headerShort">0</div>
                        <div class="stat-mini-label">Short Links</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Generator Panel -->
            <div class="generator-panel">
                <div class="section-title">Link Generator</div>
                <div class="section-subtitle">
                    Create single or batch links. Source, Medium, and Names all support batch input (one per line).
                </div>

                <div class="example-box">
                    <strong>üí° Examples:</strong>
                    <div class="example-item">Single: <code>twitter</code> + empty Names ‚Üí <code>links.comfy.org/twitter</code></div>
                    <div class="example-item">Batch Names: <code>bilibili</code> + 10 names ‚Üí 10 links like <code>bili-creator1</code></div>
                    <div class="example-item">Batch Sources: <code>Other ‚Üí tiktok, telegram</code> ‚Üí 2 links for each platform</div>
                    <div class="example-item">Combined: 3 sources √ó 5 names = 15 links!</div>
                </div>

                <div class="form-grid">
                    <div class="form-group form-group-full">
                        <label for="baseUrl" class="required">Destination URL</label>
                        <input type="text" id="baseUrl" placeholder="https://www.comfy.org/" value="https://www.comfy.org/">
                        <div class="help-text">Where users land</div>
                    </div>

                    <div class="form-group">
                        <label for="utmSource" class="required">Source</label>
                        <select id="utmSource" onchange="window.form.handleSourceChange()">
                            <option value="">-- Select --</option>
                            <optgroup label="Global Platforms">
                                <option value="twitter">twitter</option>
                                <option value="discord">discord</option>
                                <option value="github">github</option>
                                <option value="youtube">youtube</option>
                                <option value="linkedin">linkedin</option>
                                <option value="reddit">reddit</option>
                                <option value="instagram">instagram</option>
                                <option value="facebook">facebook</option>
                            </optgroup>
                            <optgroup label="Chinese Platforms">
                                <option value="bilibili">bilibili</option>
                                <option value="wechat">wechat</option>
                                <option value="wechat_group">wechat_group</option>
                            </optgroup>
                            <optgroup label="Other">
                                <option value="email">email</option>
                                <option value="partner">partner</option>
                                <option value="influencer">influencer</option>
                                <option value="comfyorg">ComfyOrg</option>
                                <option value="other">‚úèÔ∏è Other (custom)</option>
                            </optgroup>
                        </select>
                        <textarea id="utmSourceCustom" placeholder="One per line for batch:&#10;tiktok&#10;telegram&#10;newsletter" style="display: none; margin-top: 8px; min-height: 80px; resize: vertical;" oninput="window.form.updateSourceBatchIndicator()"></textarea>
                        <div id="sourceBatchIndicator" style="display: none; font-size: 11px; color: #667eea; margin-top: 5px; font-weight: 600;"></div>
                        <div class="help-text">Traffic platform (supports batch: one per line)</div>
                    </div>

                    <div class="form-group">
                        <label for="utmMedium">Medium</label>
                        <select id="utmMedium" onchange="window.form.handleMediumChange()">
                            <option value="">-- Auto --</option>
                            <option value="social">social</option>
                            <option value="video">video</option>
                            <option value="community">community</option>
                            <option value="influencer">influencer</option>
                            <option value="referral">referral</option>
                            <option value="email">email</option>
                            <option value="partner">partner</option>
                            <option value="paid_social">paid_social</option>
                            <option value="other">‚úèÔ∏è Other (custom)</option>
                        </select>
                        <textarea id="utmMediumCustom" placeholder="One per line for batch:&#10;podcast&#10;webinar" style="display: none; margin-top: 8px; min-height: 80px; resize: vertical;" oninput="window.form.updateMediumBatchIndicator()"></textarea>
                        <div id="mediumBatchIndicator" style="display: none; font-size: 11px; color: #667eea; margin-top: 5px; font-weight: 600;"></div>
                        <div class="help-text">Channel type (supports batch: one per line)</div>
                    </div>

                    <div class="form-group">
                        <label for="utmCampaign">Campaign</label>
                        <input type="text" id="utmCampaign" list="campaignSuggestions" placeholder="e.g., cloud_beta_launch_2024" onchange="window.form.updateShortAlias()">
                        <datalist id="campaignSuggestions">
                            <option value="cloud_beta_launch">
                            <option value="influencer_collab">
                            <option value="product_launch">
                            <option value="partnership">
                            <option value="webinar_series">
                            <option value="holiday_sale">
                            <option value="community_event">
                            <option value="tutorial_series">
                            <option value="showcase">
                            <option value="giveaway">
                        </datalist>
                        <div class="help-text">Marketing activity name (custom or select suggestion)</div>
                    </div>

                    <div class="form-group">
                        <label for="shortPrefix">Short Prefix</label>
                        <input type="text" id="shortPrefix" placeholder="Auto-suggested">
                        <div class="help-text">For short URLs</div>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="unifiedNoteEnabled" onchange="window.form.toggleUnifiedNote()" style="width: auto; margin: 0;">
                            <span>Use unified note for all links</span>
                        </label>
                        <div id="unifiedNoteContainer" style="display: none; margin-top: 10px;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="radio" name="noteMode" value="manual" checked style="margin: 0; width: auto;">
                                    <span style="font-weight: normal;">Manual input</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-left: 20px;">
                                    <input type="radio" name="noteMode" value="auto" style="margin: 0; width: auto;">
                                    <span style="font-weight: normal;">Auto generate from UTM</span>
                                </label>
                            </div>
                            <input type="text" id="linkNote" placeholder="Enter note (required for manual mode)" style="margin-bottom: 5px;">
                            <div class="help-text" id="noteHelpText">Enter note for all links (required)</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Mode</label>
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 8px;">
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="radio" name="defaultLinkMode" value="custom" checked style="margin-right: 8px;">
                                <span style="font-weight: normal; color: #666;">Custom</span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                <input type="radio" name="defaultLinkMode" value="random" style="margin-right: 8px;">
                                <span style="font-weight: normal; color: #666;">Random</span>
                            </label>
                        </div>
                        <div class="help-text">Default for new links</div>
                    </div>

                    <div class="form-group form-group-full">
                        <label for="batchNames">
                            Names / Variants (utm_content)
                            <button class="btn btn-small btn-secondary" onclick="window.form.clearNamesField()" style="float: right; padding: 4px 12px;">üóëÔ∏è Clear</button>
                        </label>
                        <textarea id="batchNames" placeholder="Empty = no utm_content&#10;1 line = 1 link with utm_content&#10;&#10;creator_john&#10;creator_jane"></textarea>
                        <div class="help-text">Empty: single link without content | With names: each name becomes utm_content</div>
                    </div>
                </div>

                <div id="batchIndicator" class="batch-indicator" style="display: none;">
                    Will create <strong><span id="batchCount">0</span> links</strong>
                </div>

                <button class="btn" onclick="window.form.generateLinks()" style="margin-top: 15px;">
                    ‚ö° Generate Links
                </button>
            </div>

            <!-- Table Panel -->
            <div class="table-panel">
                <div class="section-title">Generated Links</div>
                <div class="section-subtitle">
                    Edit Short Alias and Note in table. Toggle Mode switch for each link. Select rows to push to Bitly.
                </div>

                <div class="toolbar">
                    <div class="toolbar-left">
                        <span class="selection-info" id="selectionInfo">0 selected</span>
                        <button class="btn btn-small btn-success" id="bulkBitlyBtn" onclick="window.bitly.createBitlyForSelected()" disabled style="display: none;">
                            üîó Push to Bitly
                        </button>
                        <button class="btn btn-small btn-danger" id="bulkDeleteBtn" onclick="window.table.deleteSelected()" disabled>
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-small" onclick="window.storage.exportToCSV()">üíæ Export CSV</button>
                        <button class="btn btn-small btn-secondary" onclick="window.storage.importFromCSV()">üìÅ Import CSV</button>
                        <button class="btn btn-small btn-danger" onclick="window.storage.resetAllSettings()">üîÑ Reset All</button>
                        <button class="btn btn-small" id="bitlySetupBtn" onclick="window.bitly.showBitlyPanel()">üîó Bitly</button>
                    </div>
                </div>

                <input type="file" id="importFileInput" accept=".csv" onchange="window.storage.handleImportFile(event)">

                <!-- Bitly Settings Panel (will be dynamically populated) -->
                <div class="bitly-panel" id="bitlyPanel" style="display: none;"></div>

                <div class="table-container" id="tableContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No links yet. Generate your first link above!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core Modules -->
    <script src="js/config.js"></script>
    <script src="js/encryption.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/bitly.js"></script>
    <script src="js/form.js"></script>
    <script src="js/table.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/encryptionDialog.js"></script>
    
    <script>
        // Get module references
        const appState = window.appState;
        const encryption = window.encryption;
        const utils = window.utils;
        const bitly = window.bitly;
        const form = window.form;
        const table = window.table;
        const storage = window.storage;
        
        // Re-export for backward compatibility (use function wrappers to avoid declaration conflicts)
        let links = appState.getLinks();
        let selectedIndices = appState.getSelectedIndices();
        let bitlyTokenValid = appState.getBitlyTokenValid();
        
        // Legacy function references (using const to avoid declaration conflicts with encryption.js)
        const isEncryptionEnabled = () => encryption.isEncryptionEnabled();
        const getEncryptionPassword = () => encryption.getEncryptionPassword();
        const setEncryptionPassword = (password) => encryption.setEncryptionPassword(password);
        const clearEncryptionPassword = () => encryption.clearEncryptionPassword();
        const encryptData = async (data, password) => await encryption.encryptData(data, password);
        const decryptData = async (encryptedData, password) => await encryption.decryptData(encryptedData, password);
        
        function showSuccess(message, title) { return utils.showSuccess(message, title); }
        function showError(message, title) { return utils.showError(message, title); }
        function showWarning(message, title) { return utils.showWarning(message, title); }
        function showInfo(message, title) { return utils.showInfo(message, title); }
        async function showConfirm(message, title) { return await utils.showConfirm(message, title); }
        function escapeHtml(text) { return utils.escapeHtml(text); }
        function sleep(ms) { return utils.sleep(ms); }
        function downloadCSV(content, filename) { return utils.downloadCSV(content, filename); }
        function downloadJSON(content, filename) { return utils.downloadJSON(content, filename); }
        function parseCSVLine(line) { return utils.parseCSVLine(line); }
        // Toast is already available via utils.Toast - don't redeclare

        // ========== Main Application Code ==========

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            table.updateTable();
            table.updateStats();
            form.loadFormState();
            
            // Always try to check Bitly token if possible
            // If encryption is enabled but not unlocked, we'll check after unlock
            setTimeout(() => {
                // Check if we have a token (either encrypted or plain)
                const hasEncryptedToken = localStorage.getItem('bitly_api_token_encrypted');
                const hasPlainToken = localStorage.getItem('bitly_api_token');
                const isUnlocked = !encryption.isEncryptionEnabled() || encryption.getEncryptionPassword();
                
                // Only check if we have a token and (not encrypted OR already unlocked)
                if ((hasEncryptedToken || hasPlainToken) && isUnlocked) {
                    bitly.loadBitlyToken();
                    bitly.checkBitlyToken().then(() => {
                        // After token check, update selection info to show/hide Push button
                        setTimeout(() => {
                            if (window.table && window.table.updateSelectionInfo) {
                                window.table.updateSelectionInfo();
                            }
                        }, 200);
                    }).catch(err => {
                        console.error('Error checking Bitly token:', err);
                    });
                } else {
                    // No token or locked, ensure button is hidden
                    setTimeout(() => {
                        if (window.table && window.table.updateSelectionInfo) {
                            window.table.updateSelectionInfo();
                        }
                    }, 100);
                }
            }, 200);
            
            // Update batch indicator on input
            document.getElementById('batchNames').addEventListener('input', form.updateBatchIndicator);
            
            // Auto-save form state on change
            document.getElementById('baseUrl').addEventListener('change', form.saveFormState);
            document.getElementById('utmSource').addEventListener('change', form.saveFormState);
            document.getElementById('utmSourceCustom').addEventListener('input', form.saveFormState);
            document.getElementById('utmMedium').addEventListener('change', form.saveFormState);
            document.getElementById('utmMediumCustom').addEventListener('input', form.saveFormState);
            document.getElementById('utmCampaign').addEventListener('input', form.saveFormState);
            document.getElementById('shortPrefix').addEventListener('change', form.saveFormState);
            document.getElementById('linkNote').addEventListener('input', form.saveFormState);
            document.getElementById('linkNote').addEventListener('change', form.saveFormState);
            
            // Save names field on input (debounced)
            let namesSaveTimeout;
            document.getElementById('batchNames').addEventListener('input', function() {
                clearTimeout(namesSaveTimeout);
                namesSaveTimeout = setTimeout(form.saveFormState, 500);
            });
        });

        // Note: Password is stored in sessionStorage, which automatically:
        // - Persists across page refreshes (same session)
        // - Clears when browser/tab is closed (new session)
        // 
        // We don't need to manually clear password on beforeunload.
        // sessionStorage behavior handles refresh vs close automatically.
    </script>
</body>
</html>

